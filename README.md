# Outside Digital Test API

## Ссылка на задание

- [Task.md](https://github.com/Mauzzz0/outside/blob/master/Task.md)

## Ссылки на панели сервисов (доступы после разворачивания приложения)

- [Swagger](http://localhost:3000/api/)
- [PgAdmin](http://localhost:80/) - me@me.com:root
- [Postgres](http://localhost:5432/) - root:root, db

## Начало работы

* Скачать репозиторий (http)
```bash
git clone https://github.com/Mauzzz0/outside
````
* **ИЛИ** скачать репозиторий (ssh)
```bash
git clone git@github.com:Mauzzz0/outside.git
````
* Установить зависимости
```bash
cd outside/ &&
npm i 
````

## Запуск и остановка

```bash

# (Пере)Запустит сервисы, необходимые для работы приложения
npm run start:services

# Остановит сервисы, необходимые для работы приложения
npm run stop:services

# Запуск dev
npm run start

# Запуск dev с отслеживание изменений
npm run start:watch

```

## Описание

### Структура
* `./integration` - для sh скриптов, dockerfile, docker-compose и прочих вещей для ci/cd  
##### (далее пути относительно `./src`)
* `./common` - общие для всего сервера вещи: сваггер, ошибки, контракты
* `./main` - вещи, необходимые лишь для AppModule и main.ts
##### (далее пути относительно `./src/layers`)
###### Под "Новая часть системы" (НЧС) далее подразумеваются принципиально другие (новые) пути/контроллеры/модули/сервисы, чья бизнес-логика не пересекается с логикой testapi (текущая часть системы с тэгами и юзерами), архитектура "монолит". Например, добавление апи для сервиса для просмотра кино.
* `./domains` - Бизнес-логика, доменный уровень: константы, гуарды, модули и сервисы. Каждый отдельно взятый набор лежит в своей папке (в данном случае testapi), что позволяет легко расширять приложение по горизонтали, просто добавляя рядом папку с **НЧС**.
* `./gateways` - Маршрутизация, гейтвей уровень: контроллеры, типы и утилзы для них. Также позволяет легко расширяться по горизонтали. (Например, рядом с rest добавить graphql, а рядом с текущей testapi добавить **НЧС**.
* `./storage` - Общение с бд. Для каждой базы своя папка (при двух пг также необходимы 2 папки). Содержит энтити, миграции (пустые), типы для Typeorm. Если бы использовался plain sql, то запросы бы лежали в папке `./queries/plain`, а запросы orm по-хорошему должны лежать в `./queries` (но их там нет). Также больше нравится подход, когда создаётся для каждой базы свой DbService, инжектится в необходимые сервисы, а внутри себя инкапсулирует все необходимые запросы. (Не получилось сделать с typeorm и postgres, опыта не хватило, делал это только для кликхауса и mysql)

### Прочее
* Допускаются несущественные неточности в моделях и прочем функционале. (Не nickname, а username. Одна структура ответа, вместо другой. И т.п.)
* На **предположительно** тяжелые эндпоинты накинут рейтлимитер с условием "не более 10 запросов за 10 секунд"
* В `./integration/docker` лежит по идее рабочий файл. Не запускается по странной причине - не может установить зависимости для @angular/cli во время билда.
* Все дефолтный значения в сваггере валидные.
* Подход к ошибкам следующий: отдаём только 200/500. В поле code отдаём либо свой стринг код (напр. PASSWORD_TO_WEAK), либо код сгенерированной ошибки (ну и на всякий случай есть UNTRACKED_APP_ERROR). В поле message передаём дескрипшен ошибки.
* Любой ответ содержит поля: `status` (ok | error), а также payload ответа, в котором и будет полезная нагрузка ответа. На уровне со `status` можно добавлять другую информацию, это некий транспортный уровень, на который, например, можно указывать trackinId запроса (middleware express-request-id).
* Все контроллеры обёрнутый в интерсептор ResponseWithStatus, обеспечиващий функциональность из прошлого пункта
* Базовые декораторы `@nestjs/swagger` слегка изменены для большего удобства.
* Насчёт запросов typeorm не уверен что их так правильно использовать, но зато они работают)). Нет большого опыта с typeorm. Да и как сказано выше больше работы с plain sql и кликхаусом через методы, которые инкапсулируются в dbService.
* Аутентификация получилась не сильно, нет рефреш токена и /logout. (Мало работал с Аутентификацией)
* Миграции сгенерированы typeorm, но уже нет времени их заполнять и тестировать.
* Тестов нет. Кеширования нет.
